<?xml version="1.0" encoding="UTF-8"?>
<job xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
     xsi:noNamespaceSchemaLocation="../job.xsd">

    <jobName>PARTIZIONE SALDO REND SWITCH</jobName>
    <isThread>false</isThread>

    <task>
        <id>1</id>
        <name>SWITCH PART_SALDO_REND to SALDO_REND</name>

        <sqlProcess>

            <sql><![CDATA[
            
            	DECLARE
				    i INTEGER;
				BEGIN
				    SELECT COUNT(*) INTO i FROM user_tables WHERE table_name = 'PART_SALDO_REND';
				    IF i > 0 THEN
				        EXECUTE IMMEDIATE 'DROP TABLE SALDO_REND';
				        EXECUTE IMMEDIATE 'RENAME PART_SALDO_REND TO SALDO_REND';
				    END IF;
				END;
			]]></sql>

            <sql><![CDATA[
            
            	DECLARE
				    i INTEGER;
				BEGIN	
	            	SELECT COUNT(*) INTO i FROM user_constraints WHERE constraint_name =  'FK_SALDO_REND_STRUMENTOFINANZI';
					IF i = 0 THEN
					    EXECUTE IMMEDIATE 'ALTER TABLE SALDO_REND ADD CONSTRAINT FK_SALDO_REND_STRUMENTOFINANZI FOREIGN KEY (CODICETITOLO)
											REFERENCES STRUMENTOFINANZIARIO (CODICETITOLO) ENABLE NOVALIDATE';
					END IF;
            	END;
				
			]]></sql>
			
			 <sql><![CDATA[
            
            	DECLARE
				    i INTEGER;
				BEGIN	
	            	SELECT COUNT(*) INTO i FROM user_constraints WHERE constraint_name =  'FK_SALDO_REND_PORTAFOGLIO';
					IF i = 0 THEN
					    EXECUTE IMMEDIATE 'ALTER TABLE SALDO_REND ADD CONSTRAINT FK_SALDO_REND_PORTAFOGLIO FOREIGN KEY (IDPTF)
											REFERENCES PORTAFOGLIO (ID) ENABLE NOVALIDATE';
					END IF;
            	END;
				
			]]></sql>
			
			 <sql><![CDATA[
            
            	DECLARE
				    i INTEGER;
				BEGIN	
       				SELECT COUNT(*) INTO i FROM USER_INDEXES WHERE INDEX_NAME =  'IDX_SALDO_REND_PK';
					IF i = 0 THEN
					    EXECUTE IMMEDIATE 'CREATE INDEX IDX_SALDO_REND_PK ON SALDO_REND (IDPTF, CODICETITOLO, DATA) NOLOGGING INITRANS 8 PARALLEL 8 LOCAL
											STORE IN (TS_RENDIMPC_SREND_IDX_01, TS_RENDIMPC_SREND_IDX_02, TS_RENDIMPC_SREND_IDX_03, TS_RENDIMPC_SREND_IDX_04, 
												TS_RENDIMPC_SREND_IDX_05, TS_RENDIMPC_SREND_IDX_06, TS_RENDIMPC_SREND_IDX_07, TS_RENDIMPC_SREND_IDX_08, 
												TS_RENDIMPC_SREND_IDX_09, TS_RENDIMPC_SREND_IDX_10, TS_RENDIMPC_SREND_IDX_11, TS_RENDIMPC_SREND_IDX_12, 
												TS_RENDIMPC_SREND_IDX_13, TS_RENDIMPC_SREND_IDX_14, TS_RENDIMPC_SREND_IDX_15, TS_RENDIMPC_SREND_IDX_16, 
												TS_RENDIMPC_SREND_IDX_17, TS_RENDIMPC_SREND_IDX_18, TS_RENDIMPC_SREND_IDX_19, TS_RENDIMPC_SREND_IDX_20, 
												TS_RENDIMPC_SREND_IDX_21, TS_RENDIMPC_SREND_IDX_22, TS_RENDIMPC_SREND_IDX_23, TS_RENDIMPC_SREND_IDX_24, 
												TS_RENDIMPC_SREND_IDX_25, TS_RENDIMPC_SREND_IDX_26, TS_RENDIMPC_SREND_IDX_27, TS_RENDIMPC_SREND_IDX_28, 
												TS_RENDIMPC_SREND_IDX_29, TS_RENDIMPC_SREND_IDX_30, TS_RENDIMPC_SREND_IDX_31, TS_RENDIMPC_SREND_IDX_32, 
												TS_RENDIMPC_SREND_IDX_33, TS_RENDIMPC_SREND_IDX_34, TS_RENDIMPC_SREND_IDX_35, TS_RENDIMPC_SREND_IDX_36, 
												TS_RENDIMPC_SREND_IDX_37, TS_RENDIMPC_SREND_IDX_38, TS_RENDIMPC_SREND_IDX_39, TS_RENDIMPC_SREND_IDX_40)';
					END IF;
            	END;
				
			]]></sql>
			
			 <sql><![CDATA[
            
            	DECLARE
				    i INTEGER;
				BEGIN	
	            	SELECT COUNT(*) INTO i FROM user_constraints WHERE constraint_name =  'SALDO_REND_PK';
					IF i = 0 THEN
					    EXECUTE IMMEDIATE 'ALTER TABLE SALDO_REND ADD CONSTRAINT SALDO_REND_PK PRIMARY KEY (IDPTF, CODICETITOLO, DATA) USING INDEX IDX_SALDO_REND_PK';
					END IF;
            	END;
				
			]]></sql>


 			<sql><![CDATA[
            
            	DECLARE
				    i INTEGER;
				BEGIN	
       				SELECT COUNT(*) INTO i FROM USER_INDEXES WHERE INDEX_NAME =  'IX_SALDO_REND_SF_FK';
					IF i = 0 THEN
					    EXECUTE IMMEDIATE 'CREATE INDEX IX_SALDO_REND_SF_FK ON SALDO_REND (CODICETITOLO) NOLOGGING INITRANS 8 PARALLEL 8';
					END IF;
            	END;
				
			]]></sql>
			
			<sql><![CDATA[
            	ALTER TABLE RENDIMPC.SALDO_REND LOGGING
			]]></sql>


        </sqlProcess>
    </task>

</job>
