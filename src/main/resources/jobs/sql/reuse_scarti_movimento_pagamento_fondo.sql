DECLARE

CURSOR DEL_CUR IS
	SELECT /*+ parallel(8) */ SCARTO.ROWID AS SCARTO_ROWID, 
			SCARTO.*, 
			TMP.ROWID AS TMP_ROWID
	FROM TBL_SCARTI_TMP_PFMOV_PAG_FONDO SCARTO
	LEFT JOIN TMP_PFMOV_PAG_FONDO TMP
		ON( TMP.RAMO = SCARTO.RAMO
			AND TMP.CODICE_PRODOTTO = SCARTO.CODICE_PRODOTTO
			AND TMP.NUMERO_POLIZZA = SCARTO.NUMERO_POLIZZA
			AND TMP.DATA_COMUNICAZIONE_PAGAMENTO = SCARTO.DATA_COMUNICAZIONE_PAGAMENTO
			AND TMP.CF_BENEFICIARIO = SCARTO.CF_BENEFICIARIO
			AND TMP.MODALITA_PAGAMENTO = SCARTO.MODALITA_PAGAMENTO
			AND TMP.CODICE_FONDO = SCARTO.CODICE_FONDO
			)
	WHERE SCARTO.RIPROPONIBILE = 'S';

I 				NUMBER(38,0):=0;
REUSE_COUNT		NUMBER(38,0):=0;	


BEGIN

	FOR CUR_ITEM IN DEL_CUR 

		LOOP
			
		I := I+1;
		
		IF(CUR_ITEM.TMP_ROWID IS NULL) THEN
		
		INSERT /*+ append nologging parallel(8) */
				INTO TMP_PFMOV_PAG_FONDO (	RAMO,
											CODICE_PRODOTTO,
											NUMERO_POLIZZA,
											DATA_COMUNICAZIONE_PAGAMENTO,
											CF_BENEFICIARIO,
											MODALITA_PAGAMENTO,
											CODICE_FONDO,
											TIPOLOGIA_LIQUIDAZIONE,
											ISIN,
											QUOTE,
											NAV,
											IMPORTO,
											DATA_NAV,
											CODICE_ATTIVITA,
											PROVVIGIONI_INTERMEDIARIO,
											COSTO_ETF,
											COMMISSIONI_DI_GESTIONE,
											NUMERO_PRATICA
										)
								VALUES (CUR_ITEM.RAMO,
										CUR_ITEM.CODICE_PRODOTTO,
										CUR_ITEM.NUMERO_POLIZZA,
										CUR_ITEM.DATA_COMUNICAZIONE_PAGAMENTO,
										CUR_ITEM.CF_BENEFICIARIO,
										CUR_ITEM.MODALITA_PAGAMENTO,
										CUR_ITEM.CODICE_FONDO,
										CUR_ITEM.TIPOLOGIA_LIQUIDAZIONE,
										CUR_ITEM.ISIN,
										TO_NUMBER(CUR_ITEM.QUOTE, '999999999999999999999999999.999999999999999999999999999'),           
										TO_NUMBER(CUR_ITEM.NAV, '999999999999999999999999999.999999999999999999999999999'),           
										TO_NUMBER(CUR_ITEM.IMPORTO, '999999999999999999999999999.999999999999999999999999999'),           
										CUR_ITEM.DATA_NAV,
										CUR_ITEM.CODICE_ATTIVITA,
										TO_NUMBER(CUR_ITEM.PROVVIGIONI_INTERMEDIARIO, '999999999999999999999999999.999999999999999999999999999'),           
										TO_NUMBER(CUR_ITEM.COSTO_ETF, '999999999999999999999999999.999999999999999999999999999'),           
										TO_NUMBER(CUR_ITEM.COMMISSIONI_DI_GESTIONE, '999999999999999999999999999.999999999999999999999999999'),
										CUR_ITEM.NUMERO_PRATICA           
								);
										
				REUSE_COUNT := REUSE_COUNT + 1;			
				
			END IF;		
			
			DELETE /*+ nologging */ FROM TBL_SCARTI_TMP_PFMOV_PAG_FONDO TBL
			WHERE TBL.ROWID = CUR_ITEM.SCARTO_ROWID;
						
		IF MOD(I,10000) = 0 THEN
			INSERT INTO OUTPUT_PRINT_TABLE VALUES (TO_NUMBER(TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS')) || ' REUSE SCARTI TMP_PFMOV_PAG_FONDO. COMMIT ON ROW: ' || I);
			COMMIT;
		END IF;

		END LOOP;
			INSERT INTO OUTPUT_PRINT_TABLE VALUES (TO_NUMBER(TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS')) || ' REUSE SCARTI TMP_PFMOV_PAG_FONDO. RECORD RECUPERATI: ' || REUSE_COUNT);
		COMMIT;

END;